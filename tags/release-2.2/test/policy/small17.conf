# FLASK

#
# Define the security object classes 
#

class security
class process
class system
class capability

# file-related classes
class filesystem
class file
class dir
class fd
class lnk_file
class chr_file
class blk_file
class sock_file
class fifo_file

# network-related classes
class socket
class tcp_socket
class udp_socket
class rawip_socket
class node
class netif
class netlink_socket
class packet_socket
class key_socket
class unix_stream_socket
class unix_dgram_socket

# sysv-ipc-related clases
class sem
class msg
class msgq
class shm
class ipc

# FLASK
# FLASK

#
# Define initial security identifiers 
#

sid kernel


# FLASK
#
# Define common prefixes for access vectors
#
# common common_name { permission_name ... }


#
# Define a common prefix for file access vectors.
#

common file
{
	ioctl
	read
	write
	create
	getattr
	setattr
	lock
	relabelfrom
	relabelto
	append
	unlink
	link
	rename
	execute
	swapon
	quotaon
	mounton
}


#
# Define a common prefix for socket access vectors.
#

common socket
{
# inherited from file
	ioctl
	read
	write
	create
	getattr
	setattr
	lock
	relabelfrom
	relabelto
	append
# socket-specific
	bind
	connect
	listen
	accept
	getopt
	setopt
	shutdown
	recvfrom
	sendto
	recv_msg
	send_msg
	name_bind
}	

#
# Define a common prefix for ipc access vectors.
#

common ipc
{
	create
	destroy
	getattr
	setattr
	read
	write
	associate
	unix_read
	unix_write
}

#
# Define the access vectors.
#
# class class_name [ inherits common_name ] { permission_name ... }


#
# Define the access vector interpretation for file-related objects.
#

class filesystem
{
	mount
	remount
	unmount
	getattr
	relabelfrom
	relabelto
	transition
	associate
	quotamod
	quotaget
}

class dir
inherits file
{
	add_name
	remove_name
	reparent
	search
	rmdir
}

class file
inherits file
{
	execute_no_trans
	entrypoint
}

class lnk_file
inherits file

class chr_file
inherits file

class blk_file
inherits file

class sock_file
inherits file

class fifo_file
inherits file

class fd
{
	use
}


#
# Define the access vector interpretation for network-related objects.
#

class socket
inherits socket

class tcp_socket
inherits socket
{
	connectto
	newconn
	acceptfrom
}

class udp_socket
inherits socket

class rawip_socket
inherits socket

class node 
{
	tcp_recv
	tcp_send
	udp_recv
	udp_send
	rawip_recv
	rawip_send
	enforce_dest
}

class netif
{
	tcp_recv
	tcp_send
	udp_recv
	udp_send
	rawip_recv
	rawip_send
}

class netlink_socket
inherits socket

class packet_socket
inherits socket

class key_socket
inherits socket

class unix_stream_socket
inherits socket
{
	connectto
	newconn
	acceptfrom
}

class unix_dgram_socket
inherits socket


#
# Define the access vector interpretation for process-related objects
#

class process
{
	fork
	transition
	sigchld # commonly granted from child to parent
	sigkill # cannot be caught or ignored
	sigstop # cannot be caught or ignored
	signull # for kill(pid, 0)
	signal  # all other signals
	ptrace
	getsched
	setsched
	getsession
	getpgid
	setpgid
	getcap
	setcap
	share
}


#
# Define the access vector interpretation for ipc-related objects
#

class ipc
inherits ipc

class sem
inherits ipc

class msgq
inherits ipc
{
	enqueue
}

class msg
{
	send
	receive
}

class shm
inherits ipc
{
	lock
}


#
# Define the access vector interpretation for the security server. 
#

class security
{
	compute_av
	transition_sid
	member_sid
	sid_to_context
	context_to_sid
	load_policy
	get_sids
	change_sid
	get_user_sids
}


#
# Define the access vector interpretation for system operations.
#

class system
{
	ipc_info
	avc_toggle
	nfsd_control
	bdflush
	syslog_read
	syslog_mod
	syslog_console
	ichsid
}

#
# Define the access vector interpretation for controling capabilies
#

class capability
{
	# The capabilities are defined in include/linux/capability.h
	# Care should be taken to ensure that these are consistent with
	# those definitions. (Order matters)

	chown           
	dac_override    
	dac_read_search 
	fowner          
	fsetid          
	kill            
	setgid           
	setuid           
	setpcap          
	linux_immutable  
	net_bind_service 
	net_broadcast    
	net_admin        
	net_raw          
	ipc_lock         
	ipc_owner        
	sys_module       
	sys_rawio        
	sys_chroot       
	sys_ptrace       
	sys_pacct        
	sys_admin        
	sys_boot         
	sys_nice         
	sys_resource     
	sys_time         
	sys_tty_config  
	mknod
	lease
}
####################################
####################################
#####################################
# TE RULES
attribute domain;
attribute system;
attribute foo;
attribute num;
attribute num_exec;
attribute files;

type net_foo_t, foo;
type sys_foo_t, foo, system;
role system_r types sys_foo_t;

type user_t, domain;
role user_r types user_t;

type sysadm_t, domain, system;
role sysadm_r types sysadm_t;

type system_t, domain, system, foo;
role system_r types { system_t sys_foo_t };

type file_t;
type file_exec_t, files;
type dir_t;
type one_exec_t, num_exec;
type one_t, domain, num;
type two_exec_t, num_exec;
type two_t, domain, num;
type fs_t;

allow sysadm_t user_t:process transition;
allow sysadm_t ~ {system_t} : process *;
allow * * : process transition;
allow * self: process transition;
allow user_t two_t: process transition;

allow user_t sysadm_t: process transition;
allow user_t files:file execute;
allow user_t num: process transition;
allow user_t num_exec: file execute;
allow user_t one_exec_t : file execute;

allow user_t self:file *;

allow sysadm_t user_t:blk_file * ;
allow user_t user_t:file *;

allow sysadm_t user_t : fd use;
allow sysadm_t net_foo_t : file write;
allow net_foo_t net_foo_t : file read;
allow net_foo_t user_t : file write;
allow sysadm_t user_t:tcp_socket { write };
allow sysadm_t user_t:file { read write };
allow net_foo_t user_t:blk_file { read };
if (!allow_ypbind) {
allow user_t net_foo_t:blk_file { read write };
}
allow net_foo_t sysadm_t:blk_file { read write };
allow net_foo_t sys_foo_t:blk_file { read write };
allow sys_foo_t sysadm_t:blk_file { read write };
allow sys_foo_t sysadm_t:blk_file { write };
allow sys_foo_t sysadm_t:blk_file { read getattr };
allow sys_foo_t system_t:blk_file { read write };
allow system_t net_foo_t:blk_file { read write };
allow user_t system_t:blk_file { read write };
allow net_foo_t sysadm_t:blk_file { read write };
allow system_t sysadm_t:blk_file { read write };



allow system_t {user_t sysadm_t} : process transition;
allow system_t * : process transition;

allow sysadm_t file_exec_t: file { execute read write ioctl lock entrypoint };
allow one_t one_exec_t:file entrypoint;
allow one_t one_exec_t:file entrypoint;
allow num num_exec:file entrypoint;


#####################################
# Role Allow
allow user_r sysadm_r;

####################################
# Booleans
bool allow_ypbind true;


#####################################
# users
user system_u roles system_r;
user root roles { user_r sysadm_r };
user joe roles user_r;

#####################################
# constraints


####################################
#line 1 "initial_sid_contexts"

sid kernel	system_u:system_r:sys_foo_t


############################################
#line 1 "fs_use"
#
fs_use_xattr ext2 system_u:object_r:fs_t;
fs_use_xattr ext3 system_u:object_r:fs_t;
fs_use_xattr reiserfs system_u:object_r:fs_t;


genfscon proc /				system_u:object_r:sys_foo_t


####################################
#line 1 "net_contexts"

#portcon tcp 21 system_u:object_r:net_foo_t

#netifcon lo system_u:object_r:net_foo_t system_u:object_r:net_foo_t

#
#nodecon 127.0.0.1 255.255.255.255 system_u:object_r:net_foo_t

nodecon ::1 FFFF:FFFF:FFFF:FFFF:: system_u:object_r:net_foo_t




